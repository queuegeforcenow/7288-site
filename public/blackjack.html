<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ブラックジャック</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  #player-hand, #dealer-hand { margin-bottom: 15px; }
  .card { display: inline-block; border: 1px solid #333; border-radius: 5px; padding: 10px; margin-right: 5px; width: 50px; height: 70px; text-align: center; font-weight: bold; font-size: 20px; }
  button { margin-right: 10px; padding: 10px 20px; }
  #result { font-size: 1.2em; margin-top: 20px; }
  #betSection { margin-bottom: 15px; }
</style>
</head>
<body>
<h1>ブラックジャック</h1>

<div id="betSection">
  <label>ベット金額(円): <input type="number" id="betInput" min="100" step="100" value="1000"></label>
  <button id="startBtn">ゲーム開始</button>
</div>

<div>
  <div><strong>プレイヤーの手札:</strong></div>
  <div id="player-hand"></div>
</div>
<div>
  <div><strong>ディーラーの手札:</strong></div>
  <div id="dealer-hand"></div>
</div>

<div>
  <button id="hitBtn" disabled>ヒット</button>
  <button id="standBtn" disabled>スタンド</button>
</div>

<div id="result"></div>

<script>
const token = localStorage.getItem('token');
if (!token) {
  alert('ログインしてください');
  window.location.href = '/login.html';
}

const playerHandDiv = document.getElementById('player-hand');
const dealerHandDiv = document.getElementById('dealer-hand');
const resultDiv = document.getElementById('result');
const startBtn = document.getElementById('startBtn');
const hitBtn = document.getElementById('hitBtn');
const standBtn = document.getElementById('standBtn');
const betInput = document.getElementById('betInput');

function renderCards(container, cards) {
  container.innerHTML = '';
  cards.forEach(c => {
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card';
    cardDiv.textContent = c.suit === 'hidden' ? '?' : c.rank + c.suit;
    container.appendChild(cardDiv);
  });
}

async function startGame() {
  resultDiv.textContent = '';
  const bet = Number(betInput.value);
  if (bet <= 0) {
    alert('ベット金額を正しく入力してください');
    return;
  }
  try {
    const res = await fetch('/api/blackjack/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ bet })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || '開始に失敗しました');
    renderCards(playerHandDiv, data.playerHand);
    renderCards(dealerHandDiv, data.dealerHand);
    hitBtn.disabled = false;
    standBtn.disabled = false;
    startBtn.disabled = true;
    betInput.disabled = true;
  } catch (e) {
    alert(e.message);
  }
}

async function hit() {
  try {
    const res = await fetch('/api/blackjack/hit', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'ヒットに失敗');
    renderCards(playerHandDiv, data.playerHand);
    renderCards(dealerHandDiv, data.dealerHand);
    if (data.bust) {
      resultDiv.textContent = 'バースト！あなたの負けです';
      hitBtn.disabled = true;
      standBtn.disabled = true;
      startBtn.disabled = false;
      betInput.disabled = false;
    }
  } catch (e) {
    alert(e.message);
  }
}

async function stand() {
  try {
    const res = await fetch('/api/blackjack/stand', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'スタンドに失敗');
    renderCards(playerHandDiv, data.playerHand);
    renderCards(dealerHandDiv, data.dealerHand);
    resultDiv.textContent = data.result + 'です';
    hitBtn.disabled = true;
    standBtn.disabled = true;
    startBtn.disabled = false;
    betInput.disabled = false;
  } catch (e) {
    alert(e.message);
  }
}

startBtn.addEventListener('click', startGame);
hitBtn.addEventListener('click', hit);
standBtn.addEventListener('click', stand);
</script>

</body>
</html>
